{"remainingRequest":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/src/views/relate.vue?vue&type=style&index=0&lang=less&","dependencies":[{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/src/views/relate.vue","mtime":1579164402669},{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/css-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/postcss-loader/src/index.js","mtime":499162500000},{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/less-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/daiv/files/GitProjects/passwdShare/passwd-share-front/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKQGltcG9ydCAiLi9yZWxhdGUubGVzcyI7Cg=="},{"version":3,"sources":["relate.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuOA","file":"relate.vue","sourceRoot":"src/views","sourcesContent":["<template>\n  <div class=\"relate\">\n    <Row type=\"flex\" justify=\"center\" align=\"middle\" @keydown.enter.native=\"checkVaptcha\">\n      <Col style=\"width: 368px;\">\n        <Header />\n        <Row v-if=\"!relateLoading\">\n          <Tabs value=\"1\">\n            <TabPane label=\"绑定账号\" name=\"1\" icon=\"md-person-add\">\n              <Form ref=\"relateLoginForm\" :model=\"form\" :rules=\"rules\" class=\"form\">\n                <FormItem prop=\"username\">\n                  <Input\n                    v-model=\"form.username\"\n                    prefix=\"ios-contact\"\n                    size=\"large\"\n                    clearable\n                    placeholder=\"请输入用户名\"\n                    autocomplete=\"off\"\n                  />\n                </FormItem>\n                <FormItem prop=\"password\">\n                  <Input\n                    type=\"password\"\n                    v-model=\"form.password\"\n                    prefix=\"ios-lock\"\n                    size=\"large\"\n                    clearable\n                    placeholder=\"请输入密码\"\n                    autocomplete=\"off\"\n                  />\n                </FormItem>\n              </Form>\n            </TabPane>\n          </Tabs>\n          <Row>\n            <Button type=\"primary\" size=\"large\" :loading=\"loading\" @click=\"checkVaptcha\" long>\n              <span v-if=\"!loading\">立即绑定</span>\n              <span v-else>绑定中...</span>\n            </Button>\n          </Row>\n          <Row type=\"flex\" justify=\"space-between\" class=\"other-thing\">\n            <a @click=\"$router.go(-1)\" class=\"back\">\n              <Icon type=\"md-arrow-round-back\" style=\"margin-right:3px;\" />返回\n            </a>\n            <router-link to=\"/regist\">\n              <a class=\"back\">还没有账号？立即注册</a>\n            </router-link>\n          </Row>\n        </Row>\n        <div v-if=\"relateLoading\">\n          <RectLoading />\n        </div>\n        <Footer />\n      </Col>\n      <LangSwitch />\n    </Row>\n  </div>\n</template>\n\n<script>\nimport Cookies from \"js-cookie\";\nimport { vaptchaID, relate, userInfo, getJWT, getOtherSet } from \"@/api/index\";\nimport util from \"@/libs/util.js\";\nimport Header from \"@/views/main-components/header\";\nimport Footer from \"@/views/main-components/footer\";\nimport LangSwitch from \"@/views/main-components/lang-switch\";\nimport RectLoading from \"@/views/my-components/share/rect-loading\";\nvar vaptchaObject;\nexport default {\n  components: {\n    LangSwitch,\n    Header,\n    Footer,\n    RectLoading\n  },\n  data() {\n    return {\n      relateLoading: true,\n      loadingVaptcha: true,\n      loading: false,\n      verified: false,\n      form: {\n        isLogin: false,\n        username: \"\",\n        password: \"\",\n        socialType: null,\n        id: \"\",\n        token: \"\"\n      },\n      rules: {\n        username: [\n          {\n            required: true,\n            message: \"账号不能为空\",\n            trigger: \"blur\"\n          }\n        ],\n        password: [\n          {\n            required: true,\n            message: \"密码不能为空\",\n            trigger: \"blur\"\n          }\n        ]\n      }\n    };\n  },\n  methods: {\n    submitRelate() {\n      this.$refs.relateLoginForm.validate(valid => {\n        if (valid) {\n          this.loading = true;\n          this.form.isLogin = false;\n          relate(this.form).then(res => {\n            if (res.success) {\n              // 获取JWT\n              getJWT({ JWTKey: res.result }).then(res => {\n                if (res.success) {\n                  this.$Message.success(\"绑定成功\");\n                  let accessToken = res.result;\n                  this.setStore(\"accessToken\", accessToken);\n                  getOtherSet().then(res => {\n                    if (res.result) {\n                      let domain = res.result.ssoDomain;\n                      Cookies.set(\"accessToken\", accessToken, {\n                        domain: domain,\n                        expires: 7\n                      });\n                    }\n                  });\n                  // 获取用户信息\n                  userInfo().then(res => {\n                    if (res.success) {\n                      // 避免超过大小限制\n                      delete res.result.permissions;\n                      let roles = [];\n                      res.result.roles.forEach(e => {\n                        roles.push(e.name);\n                      });\n                      this.setStore(\"roles\", roles);\n                      // 保存7天\n                      Cookies.set(\"userInfo\", JSON.stringify(res.result), {\n                        expires: 7\n                      });\n                      this.setStore(\"userInfo\", res.result);\n                      this.$store.commit(\"setAvatarPath\", res.result.avatar);\n                      // 加载菜单\n                      util.initRouter(this);\n                      this.$router.push({\n                        name: \"home_index\"\n                      });\n                    } else {\n                      this.loading = false;\n                    }\n                  });\n                } else {\n                  this.loading = false;\n                }\n              });\n            } else {\n              this.loading = false;\n              vaptchaObject.reset();\n            }\n          });\n        }\n      });\n    },\n    relateDirect() {\n      // 已登录 直接绑定\n      this.form.isLogin = true;\n      relate(this.form).then(res => {\n        if (res.success) {\n          this.$Message.success(\"绑定成功\");\n        }\n        // 返回个人中心\n        this.$router.push({\n          name: \"ownspace_index\",\n          query: {\n            type: \"social\"\n          }\n        });\n      });\n    },\n    initVaptcha() {\n      let that = this;\n      vaptcha({\n        //配置参数\n        vid: vaptchaID, // 验证单元id\n        type: \"invisible\", // 展现类型 隐藏式\n        offline_server: \"你的离线验证接口地址 可选但此处不能为空\"\n      }).then(function(vaptchaObj) {\n        vaptchaObject = vaptchaObj;\n        let userInfo = Cookies.get(\"userInfo\");\n        if (userInfo) {\n          vaptchaObject.validate(); // 开始验证\n        }\n        vaptchaObj.listen(\"pass\", function() {\n          that.form.token = vaptchaObj.getToken();\n          // 验证成功 发送绑定请求\n          if (userInfo) {\n            // 直接绑定\n            that.relateDirect();\n          } else {\n            // 未登录填写表单绑定\n            that.submitRelate();\n          }\n        });\n      });\n    },\n    checkVaptcha() {\n      this.$refs.relateLoginForm.validate(valid => {\n        if (valid) {\n          vaptchaObject.validate(); // 若没验证验证码 开始验证\n        }\n      });\n    }\n  },\n  mounted() {\n    let q = this.$route.query;\n    this.form.socialType = q.socialType;\n    this.form.id = q.id;\n    // 加载验证码\n    this.initVaptcha();\n    let userInfo = Cookies.get(\"userInfo\");\n    if (!userInfo) {\n      this.relateLoading = false;\n    }\n  }\n};\n</script>\n\n<style lang=\"less\">\n@import \"./relate.less\";\n</style>\n"]}]}